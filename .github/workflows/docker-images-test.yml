name: Pull and Push Docker Images Test

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Configure Docker to use HTTP for private registry
        run: |
          echo '{"insecure-registries":["116.198.201.187:5000"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Read images.txt and process each image
        run: |
          while IFS= read -r image; do
          
            echo "Processing $image"
            docker pull $image
            image_name=$(echo $image | awk -F':' '{print $1}')
            image_tag=$(echo $image | awk -F':' '{print $2}')
            docker tag $image 116.198.201.187:5000/$image_name:$image_tag
            docker push 116.198.201.187:5000/$image_name:$image_tag
          
          done < images.txt
